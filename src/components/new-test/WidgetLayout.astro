---

interface Props {
	id: string;
	name?: string;
	isCollapsed?: boolean;
	collapsedHeight?: string;
	class?: string;
	style?: string;
}
const { id, name, isCollapsed, collapsedHeight, style } = Astro.props;
const className = Astro.props.class;
---
<widget-layout data-id={id} data-is-collapsed={String(isCollapsed)} class={"pb-4 card-base pt-1 " + className} style={style}>
    <div class="font-bold transition text-lg text-base-content relative ml-8 mt-4 mb-2
        before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
        before:absolute before:left-[-16px] before:top-[5.5px]">{name}</div>
    <div id={id} class:list={["collapse-wrapper px-4 overflow-hidden", {"collapsed": isCollapsed}]}>
        <slot></slot>
    </div>
    {isCollapsed && <div class="expand-btn px-4 -mb-2">
        <button class="btn-plain rounded-lg w-full h-9">
            <div class="text-[var(--primary)] flex items-center justify-center gap-2 -translate-x-2">
                查看更多
            </div>
        </button>
    </div>}
</widget-layout>

<style define:vars={{ collapsedHeight }}>
  .collapsed {
    height: var(--collapsedHeight);
    overflow: hidden; /* 确保内容被裁剪 */
  }

  .collapse-wrapper {
    transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* 平滑过渡 */
  }

  /* 用于隐藏/显示按钮的类 */
  .hidden {
    display: none !important;
  }
</style>

<script>
class WidgetLayout extends HTMLElement {
  constructor() {
    super();

    // 获取关键元素
    const id = this.dataset.id;
    const isCollapsed = this.dataset.isCollapsed === 'true';
    const wrapper = this.querySelector(`#${id}`);
    const expandBtn = this.querySelector('.expand-btn');
    const buttonText = expandBtn?.querySelector('button div');

    // 如果初始不是收起状态，则直接返回
    if (!isCollapsed || !expandBtn || !wrapper) {
      // 确保展开状态下，按钮是隐藏的（如果有的话）
      if (expandBtn) expandBtn.classList.add('hidden');
      return;
    }

    // 核心点击事件：切换收起/展开状态
    expandBtn.addEventListener('click', () => {
      // 再次检查 wrapper 是否存在
      if (!wrapper) return;
      
      const currentlyCollapsed = wrapper.classList.contains('collapsed');

      if (currentlyCollapsed) {
        // 执行展开：移除.collapsed类，更新按钮文本为"收起"
        wrapper.classList.remove('collapsed');
        if (buttonText) {
          buttonText.innerHTML = `收起`;
        }
      } else {
        // 执行收起：添加.collapsed类，更新按钮文本为"更多"
        wrapper.classList.add('collapsed');
        if (buttonText) {
          buttonText.innerHTML = `查看更多`;
        }
      }
    });
  }
}

// 注册自定义元素（确保只注册一次）
if (!customElements.get('widget-layout')) {
  customElements.define('widget-layout', WidgetLayout);
}
</script>